name: Rust Binary Release

on:
  workflow_call:
    inputs:
      service-name:
        type: string
        required: true
        description: "The name of the service to release"
      binary-name:
        type: string
        required: true
        description: "The name of the crate/binary to build (from Cargo.toml, e.g., 'client')"
      binary-path:
        type: string
        required: false
        default: ""
        description: "Optional: Path to crate directory (e.g., 'crates/client'). If empty, builds from workspace root using -p flag."
      prerelease:
        type: boolean
        required: true
        description: "Whether to create a prerelease"
      github-release:
        type: boolean
        required: true
        description: "Whether to create a GitHub release"
      build-env:
        type: string
        required: false
        default: ""
        description: "Compile-time env vars for .env file (e.g., 'BASE_URL=https://example.com')"
      crates-release:
        type: boolean
        required: false
        default: false
        description: "Whether to publish to crates.io"
    secrets:
      OPENAI_API_KEY:
        required: true
        description: "OpenAI API key for version and notes"
      CARGO_REGISTRY_TOKEN:
        required: false
        description: "Crates.io API token (required if crates-release is true)"

jobs:
  release-info:
    if: inputs.github-release
    uses: ./.github/workflows/generate-release-info.yml
    permissions:
      contents: read
    with:
      service-name: ${{ inputs.service-name }}
      prerelease: ${{ inputs.prerelease }}
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: release-info
    if: inputs.github-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest

          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-pc-windows-msvc
            os: windows-latest
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install deps (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y libssl-dev pkg-config

      - name: Install deps (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install openssl@3

      - name: Set OpenSSL env (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          OPENSSL_DIR=$(brew --prefix openssl@3)
          echo "OPENSSL_DIR=${OPENSSL_DIR}" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=${OPENSSL_DIR}/lib/pkgconfig" >> $GITHUB_ENV

      - name: Create .env file
        if: inputs.build-env != ''
        shell: bash
        run: echo "${{ inputs.build-env }}" > .env

      - name: Build
        shell: bash
        run: |
          if [ -n "${{ inputs.binary-path }}" ]; then
            # Build from crate directory
            cd "${{ inputs.binary-path }}"
            cargo build --release --target ${{ matrix.target }}
          else
            # Build from workspace root using -p flag
            cargo build --release --target ${{ matrix.target }} -p ${{ inputs.binary-name }}
          fi

      - name: Package
        shell: bash
        run: |
          mkdir -p artifacts
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            cp target/${{ matrix.target }}/release/${{ inputs.binary-name }}.exe artifacts/${{ inputs.binary-name }}-${{ matrix.target }}.exe
          else
            cp target/${{ matrix.target }}/release/${{ inputs.binary-name }} artifacts/${{ inputs.binary-name }}-${{ matrix.target }}
            chmod +x artifacts/${{ inputs.binary-name }}-${{ matrix.target }}
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.binary-name }}-${{ matrix.target }}
          path: artifacts/*

  github-release:
    needs: [release-info, build]
    if: inputs.github-release
    uses: ./.github/workflows/create-github-release.yml
    permissions:
      contents: write
    with:
      version: ${{ needs.release-info.outputs.version }}
      title: "${{ inputs.service-name }} v${{ needs.release-info.outputs.version }}"
      notes: ${{ needs.release-info.outputs.release_notes }}
      prerelease: ${{ inputs.prerelease }}
      artifact-pattern: ${{ inputs.binary-name }}-*

  crates-publish:
    if: inputs.crates-release
    uses: ./.github/workflows/publish-crates.yml
    with:
      crate-name: ${{ inputs.binary-name }}
      crate-path: ${{ inputs.binary-path }}
    secrets:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
