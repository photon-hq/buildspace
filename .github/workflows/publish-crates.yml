name: Publish to Crates.io

on:
  workflow_call:
    inputs:
      crate-name:
        type: string
        required: true
        description: "The name of the crate to publish (from Cargo.toml)"
      crate-path:
        type: string
        required: false
        default: ""
        description: "Optional: Path to crate directory (e.g., 'crates/client'). If empty, publishes from workspace root using -p flag."
      dry-run:
        type: boolean
        required: false
        default: false
        description: "Run cargo publish --dry-run instead of actual publish"
    secrets:
      CARGO_REGISTRY_TOKEN:
        required: true
        description: "Crates.io API token"

jobs:
  publish:
    name: Publish ${{ inputs.crate-name }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        shell: bash
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          if [ -n "${{ inputs.crate-path }}" ]; then
            # Publish from crate directory
            echo "Publishing ${{ inputs.crate-name }} from ${{ inputs.crate-path }}..."
            cd "${{ inputs.crate-path }}"
            if [ "${{ inputs.dry-run }}" == "true" ]; then
              cargo publish --dry-run
            else
              cargo publish
            fi
          else
            # Publish from workspace root using -p flag
            echo "Publishing ${{ inputs.crate-name }} from workspace root..."
            if [ "${{ inputs.dry-run }}" == "true" ]; then
              cargo publish --dry-run -p "${{ inputs.crate-name }}"
            else
              cargo publish -p "${{ inputs.crate-name }}"
            fi
          fi
